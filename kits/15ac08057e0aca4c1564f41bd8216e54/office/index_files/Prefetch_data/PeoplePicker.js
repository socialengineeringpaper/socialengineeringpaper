var PeoplePicker=new function(){var n=this,ft=null,w=null,p=null,y='Too many results, use search.',nt='Total\x3a \x7b0\x7d',k=250,u,c;this.Initialize=function(t,u){var s=$("#"+t);MissingImgUrl=u.MissingImgUrl,w=u.RemoveUserImgUrl,p=u.DeleteUserImgUrl,s.data("GetDataCommand",u.GetDataCommand),s.data("GetAddDataCommand",u.GetAddDataCommand),s.data("AddCommand",u.AddCommand),s.data("DeleteCommand",u.DeleteCommand),s.data("DeleteTooltip",u.DeleteTooltip),s.data("RemoveTooltip",u.RemoveTooltip),s.data("RemoveCommand",u.RemoveCommand),s.data("EmptyListText",u.EmptyListText),s.data("EmptySearchText",u.EmptySearchText),s.data("OnClientAfterGetData",u.OnClientAfterGetData),s.data("OnClientGetDataError",u.OnClientGetDataError),s.data("OnClientAddButtonClick",u.OnClientAddButtonClick),s.data("OnClientSelectionChanged",u.OnClientSelectionChanged),s.data("OnClientBeforeDelete",u.OnClientBeforeDelete),s.data("OnClientAfterDelete",u.OnClientAfterDelete),s.data("AllowMultiSelect",u.AllowMultiSelect),s.data("ShowUserImage",u.ShowUserImage),s.data("ShowUserTitle",u.ShowUserTitle),s.data("ShowDeleteControl",u.ShowDeleteControl),s.data("ShowRemoveControl",u.ShowRemoveControl),s.data("ListId",u.ListId),s.data("ListData",null),s.data("AddWindowBlurTimeout",null),$(".ActionBar",s).mouseover(function(){i(s,!0)}).mouseout(function(){i(s,!1)}),$(".SelectAllCheckbox",s).click(function(){this.checked?tt(s):f(s)}),$(".AddControl",s).click(function(){return(s.data("OnClientAddButtonClick")===null||s.data("OnClientAddButtonClick")()!==!1)&&ut(s),!1}),$(".DeleteControl",s).click(function(){var i=n.GetSelectedUsers(s);return(s.data("OnClientBeforeDelete")===null||s.data("OnClientBeforeDelete")(i)!==!1)&&n.DeleteUsers(s,i),!1}),$(".RemoveControl",s).click(function(){var i=n.GetSelectedUsers(s);return n.RemoveUsers(s,i),!1}),$(".AddWindow",s).keydown(function(n){if(n.which===27)return e(s),!1}),$(".AddWindow, .AddWindowSearchText, .AddWindowSearchButton, .AddWindowSearchLoading, .AddWindowList",s).focus(function(){r(s)}).blur(function(){o(s)}),$(".AddWindowSearchText, .AddWindowSearchButton",s).keydown(function(n){if(n.which===13)return v(s),!1}),$(".AddWindowSearchButton",s).click(function(){return r(s),v(s),!1}),$(".AddWindowList",s).scroll(function(){r(s)}),u.LoadOnStartup&&n.Search(s)};var v=function(n){if(n.data("GetAddDataCommand")){var i=$.trim($(".AddWindowSearchText",n).val()),t=$(".AddWindowSearchLoading",n);t.show(),n.data("GetAddDataCommand")(n.data("ListId"),i,function(i){t.hide(),rt(n,i)})}},a=function(n,t){var i=t.data("UserData");i&&n.data("AddCommand")&&n.data("AddCommand")(n.data("ListId"),i.Id,function(t){(t===!0||t==="1")&&($(".EmptyListPrompt",n).remove(),l(n,i)),e(n)})},l=function(n,i){var r=h(n,i);$(".List tbody",n).prepend(r),t(n)},ut=function(n){var t=$(".AddWindow",n);t.is(":hidden")&&(i(n,!1),$(".SearchCell",n).css("visibility","hidden"),$(".AddWindowList",n).hide(),t.show(),$(".AddWindowSearchText",n).val("").focus())},e=function(n){var t=$(".AddWindow",n);t.is(":visible")&&($(".SearchCell",n).css("visibility","visible"),t.hide(),i(n,!1),$(".AddControl",n).focus())};this.Search=function(n,t){var i,r;n=$(typeof n=="string"?document.getElementById(n):n),n.data("GetDataCommand")?(typeof SearchBox!="undefined"&&typeof t!="string"&&(t=$.trim(SearchBox.GetText(n.attr("id")+"_SearchBox"))),i=$(".SearchLoading",n),i.show(),r=$(".List",n),r.css("visibility","hidden"),typeof PageLayout!="undefined"&&PageLayout.ResizePanels(),n.data("GetDataCommand")(n.data("ListId"),t,function(t){it(n,t),i.hide(),r.css("visibility","visible"),n.data("OnClientAfterGetData")&&n.data("OnClientAfterGetData")()},function(t){i.hide(),r.css("visibility","visible");var u=Sys.Serialization.JavaScriptSerializer.serialize(t);O365.Log.WriteLog(401389,O365.LogLevel.Error,O365.LogArea.UserManagement,O365.LogParameter.Empty,u),n.data("OnClientGetDataError")&&n.data("OnClientGetDataError")()})):s(n)},this.DeleteUsers=function(n,t){n=$(typeof n=="string"?document.getElementById(n):n);var i=$.map(t,function(n){if(n)return n.Id});n.data("DeleteCommand")?n.data("DeleteCommand")(n.data("ListId"),Sys.Serialization.JavaScriptSerializer.serialize(i),function(t){(n.data("OnClientAfterDelete")===null||n.data("OnClientAfterDelete")(t)!==!1)&&u(n,t.UsersSucceeded)}):u(n,i)},this.RemoveUsers=function(n,t){n=$(typeof n=="string"?document.getElementById(n):n);var i=$.map(t,function(n){if(n)return n.Id});n.data("RemoveCommand")?n.data("RemoveCommand")(n.data("ListId"),Sys.Serialization.JavaScriptSerializer.serialize(i),function(t){t&&u(n,t.UsersSucceeded)}):u(n,i)},u=function(n,t){if(t)for(var i=0;i<t.length;i++)c(n,t[i])},c=function(i,r){var u=i.data("ListData");$(".List tr",i).each(function(){var f=$(this),e=f.data("UserData");e&&e.Id===r&&(f.remove(),u&&u.TotalUsersCount>0&&(u.TotalUsersCount-=1),n.GetUsers(i).length==0&&s(i),t(i))})},this.GetUser=function(t,i){for(var u=n.GetUsers(t),r=0;r<u.length;r++)if(u[r].Id===i)return u[r];return null},this.GetUsers=function(n){n=$(typeof n=="string"?document.getElementById(n):n);var t=[];return $(".List tr",n).each(function(){var n=$(this);n.data("UserData")&&t.push(n.data("UserData"))}),t},this.GetSelectedUsers=function(n){n=$(typeof n=="string"?document.getElementById(n):n);var t=[];return $(".List .Checkbox:checked",n).each(function(){var n=$(this).parents(".List tr");n.data("UserData")&&t.push(n.data("UserData"))}),t},this.SetSelectedUsers=function(n,i){n=$(typeof n=="string"?document.getElementById(n):n),f(n);var r=$.map(i,function(n){if(n)return n.Id});$(".List tr",n).each(function(){var n=$(this);n.data("UserData")&&$.inArray(n.data("UserData").Id,r)>=0&&n.find("input[type=checkbox]").attr("checked","checked")}),t(n)},this.InsertUser=function(n,t){var n=$(typeof n=="string"?document.getElementById(n):n);l(n,t)};var s=function(n){if(n.data("EmptyListText")){$(".EmptyListPrompt",n).remove();var t=$("<tr />").addClass("EmptyListPrompt"),i=$("<td />").text(n.data("EmptyListText"));t.append(i),$(".List tbody",n).append(t)}},d=function(n,t){var r=$(".AddWindow",n);(r.length===0||r.is(":hidden"))&&t.addClass("Highlight ms-bgc-nl"),i(n,!0)},g=function(n,t){var r=$(".AddWindow",n);(r.length===0||r.is(":hidden"))&&t.removeClass("Highlight ms-bgc-nl"),i(n,!1)},r=function(n){n.data("AddWindowBlurTimeout")&&(window.clearTimeout(n.data("AddWindowBlurTimeout")),n.data("AddWindowBlurTimeout",null))},o=function(n){n.data("AddWindowBlurTimeout")===null&&n.data("AddWindowBlurTimeout",window.setTimeout(function(){e(n)},k))},t=function(t){var r,f,s,u;t.data("OnClientSelectionChanged")&&t.data("OnClientSelectionChanged")(n.GetSelectedUsers(t));var h=$(".List .Checkbox",t),e=!1,o=!0,c=0;h.each(function(){var t=$(this),n=t.parents(".List tr");c+=1,this.checked?(n.addClass("Selected ms-bgc-nl"),e=!0):(n.removeClass("Selected ms-bgc-nl"),o=!1)}),$(".SelectAllCheckbox",t).attr("checked",o),i(t,!1),$(".DeleteControl, .RemoveControl",t).css("visibility",e?"visible":"hidden"),r=t.data("ListData"),r&&(t.data("EmptyListText")&&($(".EmptyListPrompt",t).remove(),(typeof r.SearchString!="string"||r.SearchString.length===0)&&n.GetUsers(t).length===0&&(f=$("<tr />").addClass("EmptyListPrompt"),s=$("<td />").text(t.data("EmptyListText")),f.append(s),$(".List tbody",t).append(f))),u=$(".TotalUsersCount",t),r.TotalUsersCount>0?(u.text(String.format(nt,r.TotalUsersCount)),u.css("visibility","visible")):u.css("visibility","hidden")),typeof PageLayout!="undefined"&&PageLayout.ResizePanels()},i=function(n,t){var i=$(".SelectAllCheckbox",n),r;i.length>0&&(r=!1,(t||i.is(":checked")||$(".List .Checkbox:checked",n).length>0)&&!$(".AddWindow",n).is(":visible")&&(r=!0),i.toggleClass("show",r))},tt=function(n){var i=$(".List .Checkbox",n);i.attr("checked","checked"),t(n)},f=function(n){var i=$(".List .Checkbox",n);i.removeAttr("checked"),t(n)},it=function(n,i){var f,o,r,e;if(i){n.data("ListData",i);var c=n.data("ShowImage"),l=n.data("ShowTitle"),a=n.data("ShowDeleteControl"),v=n.data("ShowRemoveControl"),s=n.data("AllowMultiSelect"),u=$(".List tbody",n);if($(u).empty(),i.Users&&i.Users.length>0){for(f=0;f<i.Users.length;f++)o=h(n,i.Users[f]),u.append(o);(i.MoreUsers===!0||i.MoreUsers==="1")&&(r=$("<tr />").addClass("MoreUsersPrompt"),s&&r.append($("<td />")),e=$("<td />").text(y),r.append(e),u.append(r))}else typeof i.SearchString=="string"&&i.SearchString.length>0&&n.data("EmptySearchText")&&(r=$("<tr />").addClass("EmptySearchPrompt"),e=$("<td />").text(n.data("EmptySearchText")),r.append(e),u.append(r));t(n)}},rt=function(n,t){var o=$(".AddWindowList",n),f,i,e;if(t){var h=n.data("ShowUserImage"),c=n.data("ShowUserTitle"),u=$(".AddWindowList tbody",n).empty();if(t.Users&&t.Users.length>0){for(o.show(),f=0;f<t.Users.length;f++){var s=t.Users[f],i=$("<tr />").addClass("UserDataTr").data("UserData",s).keydown(function(t){switch(t.which){case 13:return a(n,$(this)),!1;case 38:return $(this).is(":first-child")?$(this).nextAll(":last-child").find('td').focus():$(this).prev().find('td').focus(),r(n),!1;case 40:return $(this).is(":last-child")?$(this).prevAll(":first-child").find('td').focus():$(this).next().find('td').focus(),r(n),!1}}).click(function(){return a(n,$(this)),!1}),l=b(n,s,h,c,!1,!1,!1);i.append(l),u.append(i)}(t.MoreUsers===!0||t.MoreUsers==="1")&&(i=$("<tr />").addClass("MoreUsersPrompt"),e=$("<td />").text(y),i.append(e),u.append(i)),u.children(":first-child").find('td').focus(),r(n)}else n.data("EmptySearchText")&&(o.show(),i=$("<tr />").addClass("EmptySearchPrompt"),e=$("<td />").text(n.data("EmptySearchText")),i.append(e),u.append(i)),$(".AddWindowSearchText",n).focus()}},h=function(i,r){var k=i.data("ShowUserImage"),nt=i.data("ShowUserTitle"),h=i.data("ShowDeleteControl"),c=i.data("ShowRemoveControl"),v=i.data("AllowMultiSelect"),u=$("<tr />").addClass("UserDataTr").data("UserData",r).mouseover(function(){d(i,u)}).mouseout(function(){g(i,u)}),y=b(i,r,k,nt,h,c,v),l,a,o,e,s;return v&&(l=$("<input />").attr("type","checkbox").attr("title",r.Name).addClass("Checkbox concealable").click(function(){t(i)}),a=$("<td />").addClass("CheckboxTd ms-bgc-w"),a.append(l),u.append(a),y.click(function(){f(i),l.attr("checked","checked"),t(i)})),u.append(y),(c||h)&&(o=$("<td />").addClass("ActionTd"),h&&(e=$("<a />").addClass("Delete concealable").attr("href","#").attr("title",i.data("DeleteTooltip")).attr("aria-label",i.data("DeleteTooltip")).attr("role","button").click(function(){return(i.data("OnClientBeforeDelete")===null||i.data("OnClientBeforeDelete")([r])!==!1)&&n.DeleteUsers(i,[r]),!1}),s=$("<img />").attr("src",p).attr("alt",i.data("DeleteTooltip")).attr("type","image").attr("title",i.data("DeleteTooltip")).attr("aria-label",i.data("DeleteTooltip")),e.append(s),o.append(e)),c&&(e=$("<a />").addClass("Remove concealable").attr("href","#").attr("title",i.data("RemoveTooltip")).attr("aria-label",i.data("RemoveTooltip")).attr("role","button").click(function(){return n.RemoveUsers(i,[r]),!1}),s=$("<img />").attr("src",w).attr("alt",i.data("RemoveTooltip")).attr("aria-label",i.data("RemoveTooltip")).attr("type","image").attr("title",i.data("RemoveTooltip")),e.append(s),o.append(e)),u.append(o)),u},b=function(n,t,i,u){var c=$("<td />").attr("tabindex","0").addClass("UserDataTd ms-bgc-nl-h ms-bgc-nl-f").focus(function(){r(n)}).blur(function(){o(n)}),l,h,a,v;return i&&(l=$("<img />").attr("alt","").attr("src",t.ImageUrl||MissingImgUrl).addClass("Photo"),c.append(l)),h=$("<span />").addClass("Text"),a=$("<span />").addClass(i||u?"Name":"NameOnly ms-fcl-np").text(t.Name||t.Id),h.append(a),u&&(h.append($("<br />")),v=$("<span />").addClass("Title").text(t.Title||" "),h.append(v)),c.append(h),c}}